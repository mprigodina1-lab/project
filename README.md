Задача: реализовать получение, обработку и хранение данных погоды из открытого источника для использования в скрипте-виджете, который можно встроить в страницу сайта.
Авторы: Малащенко Мария Степановна, Горбушин Алексей Алексеевич

Общее описание.
1.	Для получения данных мы будем использовать https://api.openweathermap.org/data/2.5/weather - бесплатный сайт погоды OpenWeatherMap, открытый API. Учитываем, что в любом случае, для этого телефона потребуется доступ выхода в Интернет.
2.	Получение будет реализовано скриптом на Python, запуск в автоматическом режиме возможен посредством:
2.1.	Через ручной запуск скрипта. Предполагаем, что такой подход возможен при редкой смене погоды. Предположительно, человек в начале рабочего дня запускает скрипт, и в течение всего дня пользователи, получающие прогноз, имеют одни и те же показатели.
2.2.	Через автоматический запуск скрипта в консоли, на отдельном сервере (предпочтительно) или на сервере с БД, зависит от требований безопасности. 
2.3.	С помощью программ – автоматических расписаний-планировщиков (шедулеров), например, AirFlow (мы используем именно этот вариант).
3.	Данные будут храниться в БД PostgreSQL. 
3.1.	Прогнозные данные – те, что будут, например, выводиться на виджет, или рисоваться на графике-прогнозе на день
3.2.	«Свершившиеся» данные, пригодные, например, для аналитики и прочих задач. 
4.	Отображение данных.
4.1.	Отображение прогноза – в виде виджета и в виде графика на день. 
4.2.	Отображение данных, например, за текущий (прошедший) месяц – с использованием Apache Superset
 
В рамках проекта погодные данные из открытых источников используются как контекстный слой, позволяющий объяснять изменения дорожной ситуации. Виджет интегрируется в интерфейс приложения и помогает пользователям понять, каким образом текущие погодные условия могут влиять на интенсивность движения, возникновение пробок и рост аварийности.
1.	Определение области проекта:
Транспорт и дорожное движение
Основной фокус — интеграция виджета, отображающего текущую погоду, для анализа и отображения дорожной ситуации в реальном времени.
2.	Сбор данных:
Для получения данных используется https://api.openweathermap.org/data/2.5/weather - бесплатный сайт погоды OpenWeatherMap, открытый API. Реализация получения данных идет путем получения данных текущей погоды и получения прогноза:
Структура данных.
2.1.	Получаемый формат данных
Для текущей погоды
JSON
{
	"coord": {
		"lon": 37.9,
		"lat": 59.1
	},
	"weather": [
		{
			"id": 804,
			"main": "Clouds",
			"description": "пасмурно",
			"icon": "04d"
		}
	],
	"base": "stations",
	"main": {
		"temp": 3,
		"feels_like": -0.32,
		"temp_min": 3,
		"temp_max": 3,
		"pressure": 1017,
		"humidity": 100,
		"sea_level": 1017,
		"grnd_level": 1002
	},
	"wind": {
		"speed": 3.57,
		"deg": 244,
		"gust": 7.77
	},
	"clouds": {
		"all": 100
	},
	"dt": 1765969621,
	"sys": {
		"type": 1,
		"id": 8931,
		"country": "RU",
		"sunrise": 1765952359,
		"sunset": 1765974585
	},
	"timezone": 10800,
	"id": 569223,
	"name": "Череповец",
	"cod": 200
}

Прогноз
JSON
{
	"cod": "200",
	"message": 0,
	"cnt": 40,
	"list": [
		{
			"dt": 1765972800,
			"main": {
				"temp": 3,
				"feels_like": -0.31,
				"temp_min": 1.23,
				"temp_max": 3,
				"pressure": 1017,
				"sea_level": 1017,
				"grnd_level": 1003,
				"humidity": 99,
				"temp_kf": 1.77
			},
			"weather": [
				{
					"id": 804,
					"main": "Clouds",
					"description": "пасмурно",
					"icon": "04d"
				}
			],
			"clouds": {
				"all": 100
			},
			"wind": {
				"speed": 3.56,
				"deg": 245,
				"gust": 7.92
			},
			"pop": 0,
			"sys": {
				"pod": "d"
			},
			"dt_txt": "2025-12-17 12:00:00"
		}
		~~~ продолжение по каждому часу
	],
	"city": {
		"id": 569223,
		"name": "Череповец",
		"coord": {
			"lat": 59.1,
			"lon": 37.9
		},
		"country": "RU",
		"population": 311850,
		"timezone": 10800,
		"sunrise": 1765952359,
		"sunset": 1765974585
	}
}
Структура БД
1.	Создание БД (выделение сервера, установка PostgreSQL)
SQL
CREATE DATABASE "meteo" WITH OWNER = "postgres";
CREATE SCHEMA 	"meteo" AUTHORIZATION "postgres";

2.	Параметры БД
host	"192.168.*.*"
port	5432
database	"meteo"
user	"user_name"
password	"user_password"
3.	Создание таблиц
3.1.	CURRENT_WEATHER (Текущая погода)
Name	Type	Length	Dec	Not NULL	Key	Description
id	int4	32	0	Да	Да	
date	timestamp	6	0	Да		дата измерений
weather_id	int2	16	0			Идентификатор погодных условий
weather_main	varchar	50	0			Группа погодных параметров (Дождь, Снег, Экстрим и др.)
weather_description	varchar	50	0			Погодные условия в группе на своем языке
weather_icon	varchar	10	0			Идентификатор значка погоды
current_temp	numeric	6	2			Температура
current_feels_like	numeric	6	2			как ощущается
current_pressure	numeric	6	2			Атмосферное давление, гПа
current_humidity	numeric	6	2			Влажность,%
current_visibility	int2	16	0			видимость
current_wind_speed	numeric	6	2			Скорость ветра, метр / сек
current_wind_deg	numeric	6	2			Направление ветра, градусы
current_clouds	numeric	6	2			Облачность,%
current_rain_1h	numeric	6	2			Объем дождя за последний час, мм
current_snow_1h	numeric	6	2			Объем снега за 1 час, мм
current_sunrise	timestamp	6	0			Время восхода, unix, UTC
current_sunset	timestamp	6	0			Время заката, unix, UTC
current_uvi	numeric	6	2			Текущий УФ-индекс
current_dew_point	numeric	6	2			Атмосферная температура (меняется в зависимости от давления и влажности), ниже которой капли воды начинают конденсироваться и может образовываться роса
current_wind_gust	numeric	6	2			Порыв ветра. Единицы - по умолчанию: метр / сек, метрическая система: метр / сек, британская: мили / час.

Файл - Create_table_current_weather.sql
3.2.	FORECAST_HOURLY (почасовой прогноз)
Name	Type	Length	Dec	Not NULL	Key	Description
id	int4	32	0	Да	Да	Идентификатор
date	timestamp	6	0	Да		дата измерений
hourly_temp	numeric	6	2			Температура. Units – default: kelvin, metric: Celsius, imperial: Fahrenheit.
hourly_feels_like	numeric	6	2			Температура. Человеческое восприятие погоды, ощущается как. Units – default: kelvin, metric: Celsius, imperial: Fahrenheit. 
hourly_pressure	numeric	6	2			Атмосферное давление на уровне моря, hPa
hourly_humidity	numeric	6	2			Влажность, %
hourly_dew_point	numeric	6	2			Атмосферная температура (изменяющаяся в зависимости от давления и влажности), ниже которой капли воды начинают конденсироваться и может образовываться роса. Units – default: kelvin, metric: Celsius, imperial: Fahrenheit
hourly_uvi	numeric	6	2			УФ-индекс
hourly_clouds	numeric	6	2			Облачность, %
hourly_visibility	int2	16	0			Средняя видимость, metres
hourly_wind_speed	numeric	6	2			Скорость ветра. Units – default: metre/sec, metric: metre/sec, imperial: miles/hour
hourly_wind_gust	numeric	6	2			Порывы ветра. Units – default: metre/sec, metric: metre/sec, imperial: miles/hour.
hourly_wind_deg	numeric	6	2			Направление ветра, градусы
hourly_pop	numeric	6	2			Вероятность осадков
hourly_rain_1h	numeric	6	2			Объем осадков - дождя за прошлый час, mm
hourly_snow_1h	numeric	6	2			Объем осадков - снега за прошлый час, mm
weather_id	int2	16	0			Идентификатор погодных условий
weather_main	varchar	50	0			Группа погодных условий (Rain, Snow, Extreme etc.)
weather_description	varchar	50	0			Погодные условия внутри группы (Дождь - Легкий дождь)
weather_icon	varchar	10	0			Идентификатор иконки погоды

Файл - Create_table_forecast_hourly.sql
 
3.3.	WEATHER_LEGEND (легенда, расшифровка погоды для отображения)
Name	Type	Length	Dec	Not NULL	Key	Description
id	int4	32	0	Да	Да	Идентификатор
group	int4	32	0			Группа
main	varchar	0	0			Наименование
description	varchar	0	0			Описание
icon_day	varchar	0	0			Иконка дневная
icon_night	varchar	0	0			Иконка ночная

Файл - Create_table_weather_legend.sql
Пример данных
 

3.4.	WIND_DEG (расшифровка направления ветров)
Name	Type	Length	Dec	Not NULL	Key	Description
id	int4	32	0	Да	Да	
wind_deg_from	int4	32	0			Градус-начало сектора
wind_deg_to	int4	32	0			Градус-окончание сектора
name	varchar	255	0			Наименование направления ветра
full_name	varchar	255	0			Полное наименование направления ветра
order_num	int4	32	0			№ п/п

Файл - Create_table_wind_deg.sql
Пример данных
 

4.	Процесс получения данных
4.1.	Подключение к сайту openweathermap.org осуществляется через api сайта
4.1.1.	Метод https://api.openweathermap.org/data/2.5/weather? (получаемый json Для текущей погоды)
4.1.2.	Метод https://api.openweathermap.org/data/2.5/forecast? (получаемый json Прогноз)
4.1.3.	Параметры для методов
lat = 59.9	# долгота в десятичном формате
lon = 30.3 	# широта в десятичном формате
exclude = 'minutely,alerts'	# исключения без пробелов через запятую current,minutely,hourly,daily,alerts
lang = 'ru	# язык для комментариев
units = 'metric'	# 'standard' - Кельвин, 'metric' - Цельсий, 'imperial' - Фаренгейт

4.2.	Обращение к api-методам осуществляется через Python-скрипт. В самом скрипте выполняется передача данных, полученных с сайта, в БД с помощью библиотеки psycopg2
Файл - get_api.py
4.3.	Из скрипта вызываются хранимые процедуры, которые располагаются на БД и выполняют запись данных. Здесь производится проверка данных на корректность с точки зрения целостности БД (например, запись не будет произведена, если придет категория погоды, для которой нет соответствия легенды, направления ветра), а также с точки зрения физического соответствия. Например, превышение температуры окружающего воздуха значений 50С и выше
4.3.1.	 Запись текущей погоды
Файл - meteo_current_weather.sql
4.3.2.	Запись прогноза погоды
Файл - meteo_forecast_hourly.sql
	Алгоритм предполагает, что почасовой прогноз, записанный в предыдущий раз, удаляется (очищается 	из таблицы), затем заменяется на новый, пришедший на текущее время. Текущая погода, реальное состояние дописывается в таблицу актуальной погоды, там будет храниться фактическая погода за время, определенное потребностями задачи.
5.	Автоматизация запуска скриптов
Автоматизация процесса состоит в том, чтобы переложить запуск написанного нами Python-скрипта (get_api.py) на: 
-	.bat/.py-файл, который будет запускаться каждое определенное число часов/минут/секунд и работать на сервере под наблюдением и администрированием;
-	любой планировщик, который способен запускать скрипты, установленный на сервере, где есть Python, выход в интернет и открыт доступ к внутренней сети и нашей БД (как правило, она устанавливается на другом сервере);
-	скрипт запускает написанные на БД хранимые процедуры, для этого мы создаем специального пользователя с доступом.
В нашем случае мы используем Apache Airflow Version: v2.5.0.
Для того, чтобы Python-файл адаптировать для запуска из AirFlow (он работает с DAG-скриптами), в заголовке снимаем комментарии с подключения библиотеки Airflow и комментарии вызова. И комментируем вызов функций синтаксиса Python. 
Пример кода
 

Пример запуска
 
 
6.	Очистка данных
Данные сайта погоды OpenWeatherMap достаточно достоверны для того, чтобы мы их размещали напрямую в БД. На сайте работают собственные механизмы проверки данных, которые позволяют пользоваться ими без дополнительного «приземления данных». Очистка, проверка данных на недостоверность не требуется.
Обычный порядок работы с данными таков:
-	Получение и «приземление» данных, размещение их в таблице/таблицах, соответствующих структурам получаемых данных, с отслеживанием даты загрузки, возможно, порции, и прочим.
-	Парсинг и очистка данных, возможно, выделение только необходимых данных, с проставлением даты обработки, признака использования.
-	Перенос обработанных данных/части данных в целевые таблицы, годные для использования этих данных. Возможно, выделение справочной информации, сопоставление изменений с существующими данными и обновление их по оговоренным алгоритмам.
-	Работа с целевыми таблицами – запросы приложений.
А также необходимо отметить, что очистка данных может производиться не только на уровне физического соответствия структуре БД, но и бизнес-правилам, например:
-	В поле целого числа (например, мы могли скачивать скорость ветра – 1м/с, 2 м/с и так далее), определив это поле как целое число. Гипотетически (например, после обновления сайта, улучшения оборудования, изменения региона) мы можем получить значение для этого поля типа decimal, например, 2.5 м/с. Это ошибка несоответствия структуре данных БД. Ошибку при загрузке мы получим от БД.
-	Для прогноза мы берем данные только на будущий час. Неважно, что сайт отдает на предыдущий день, но нам нужны только на будущий час. Эти условия мы должны реализовать самостоятельно, отсеяв строки за другие часы. Ошибки здесь мы не получим, но бизнес-правилу эти данные не соответствуют, их не должно быть в целевой таблице.
-	Мы получили температуру воздуха +50, хотя сейчас декабрь, и город СПб. Это бизнес-правило относится к тем, которые играют роль исключительно в определенных условиях. Эта температура окружающего воздуха вполне допустима в других условиях, например, в пустыне, на Экваторе, в сауне и т.д., но здесь мы отнесем такое значение к ошибке по бизнес-правилу. 
В нашем примере мы используем дополнение «очистки данных» - проверку по бизнес-правилам на превышение температуры. Включим ее на уровне БД – не будем записывать «ошибочные» данные, допишем условия.
SQL
-- дописываем к скрипту "meteo"."add_current_weather"
WHERE
-- температура воздуха, С	
	((t.val::json -> 'main')::json ->> 'temp')::DECIMAL(6,2) < 50 AND 
-- скорость ветра, м/с
	(t.val::json -> 'wind' ->> 'speed')::DECIMAL(6,2) < 20

SQL
-- дописываем к скрипту "meteo"."add_forecast_hourly"
WHERE
-- температура воздуха, С	
	(jd.val -> 'main' ->> 'temp')::DECIMAL(6,2) < 50 AND 
-- скорость ветра, м/с
	(jd.val -> 'wind' ->> 'speed')::DECIMAL(6,2) < 20

7.	Визуализация
7.1.	Отображение текущей актуальной погоды на странице.
Файл – cw.zip
Запрос
SQL
SELECT * FROM "meteo"."get_current_weather"()

Функция содержит в себе следующий запрос:
Файл - get_current_weather.sql
 
7.2.	Прогноз на ближайшие 3 дня (Apache Superset)


7.3.	Ближайшие 3 часа (Apache Superset)

7.4.	Запрос (содержимое функции в файле)
SQL
SELECT * FROM "meteo"."get_hourly_weather"()
Функция по умолчанию возвращает прогноз погоды на ближайшие 3 дня. Но также разрешает передать параметр – дату, с которой необходимо отсчитать 3 дня.

7.5.	Направление ветра (Apache Superset)

Запрос
SQL
SELECT hourly_wind_desc AS hourly_wind_desc,
MIN(hourly_wind_speed) FILTER (WHERE hourly_wind_desc = 'С') AS "С", 
MIN(hourly_wind_speed) FILTER (WHERE hourly_wind_desc = 'СЗ') AS "СЗ", 
MIN(hourly_wind_speed) FILTER (WHERE hourly_wind_desc = 'СВ') AS "СВ", 
MIN(hourly_wind_speed) FILTER (WHERE hourly_wind_desc = 'В') AS "В", 
MIN(hourly_wind_speed) FILTER (WHERE hourly_wind_desc = 'ЮВ') AS "ЮВ", 
MIN(hourly_wind_speed) FILTER (WHERE hourly_wind_desc = 'Ю') AS "Ю",
MIN(hourly_wind_speed) FILTER (WHERE hourly_wind_desc = 'ЮЗ') AS "ЮЗ", 
MIN(hourly_wind_speed) FILTER (WHERE hourly_wind_desc = 'З') AS "З" 
FROM
(SELECT  date + make_interval(hours => hour) AS dd, * FROM "meteo"."get_hourly_weather"()
) AS virtual_table GROUP BY hourly_wind_desc ORDER BY "С" DESC 


7.6.	Графики по фактической погодной обстановке за прошлый период (Apache Superset)

Сравнение средних температур за месяц

Запрос
SQL
SELECT EXTRACT('MONTH' FROM "date")::INTEGER AS month, AVG(current_temp) AS "2025" 
FROM (SELECT 
			cw.id,
			cw.date::TIMESTAMP,
			cw.weather_id,
			cw.current_temp::DECIMAL(6,2),
			cw.current_feels_like,
			cw.current_wind_speed
			
	FROM meteo.current_weather			cw
	WHERE
				cw.date >= '2024-01-01 00:00:00' AND
				cw.date <= '2026-01-01 00:00:00'
) AS virtual_table 
WHERE EXTRACT('YEAR' FROM "date")::INTEGER = '2025' GROUP BY EXTRACT('MONTH' FROM "date")::INTEGER ORDER BY "2025" DESC 
 LIMIT 1000;



<img width="523" height="450" alt="image" src="https://github.com/user-attachments/assets/792892ba-d1d8-49a3-a639-82241b086060" />
# project
